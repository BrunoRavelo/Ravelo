<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pintura AR</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- A-Frame y WebXR Polyfill -->
    <script src="https://unpkg.com/aframe@1.4.1/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.js"></script>
    <style>
        /* Overlay genérico */
        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
            padding: 1rem;
        }
        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center; justify-content: center;
            color: white; z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Advertencia dispositivos no móviles -->
    <div id="mobile-warning" class="overlay d-flex">
        <p class="h5 mb-4">Esta experiencia AR solo funciona en celulares y tablets.<br>Por favor, abre desde un dispositivo compatible.</p>
        <button id="btn-back" class="btn btn-light">Volver</button>
    </div>

    <!-- Selector de tamaños -->
    <div class="container-fluid fixed-top mt-2" id="size-select">
        <div class="row gx-1 justify-content-center">
            <div class="col-auto"><button class="btn btn-sm btn-primary size-btn" data-width="40" data-height="50">40×50 cm</button></div>
            <div class="col-auto"><button class="btn btn-sm btn-primary size-btn" data-width="50" data-height="70">50×70 cm</button></div>
            <div class="col-auto"><button class="btn btn-sm btn-primary size-btn" data-width="70" data-height="100">70×100 cm</button></div>
            <div class="col-auto"><button class="btn btn-sm btn-primary size-btn" data-width="100" data-height="120">100×120 cm</button></div>
        </div>
    </div>

    <!-- Loader / Indicador de escaneo -->
    <div id="loader" class="d-flex">
        <div class="text-center">
            <p id="loader-text">Mueve el dispositivo lentamente en círculos para detectar superficies</p>
            <div class="spinner-border text-light"></div>
        </div>
    </div>

    <!-- Escena A-Frame con WebXR Hit Test -->
    <a-scene embedded vr-mode-ui="enabled: false"
             webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #size-select"
             ar-hit-test="target: #painting;">

        <!-- Cámara -->
        <a-camera id="camera"></a-camera>

        <!-- Pintura AR, oculto hasta colocación -->
        <a-entity id="painting"
                  geometry="primitive: plane; width: 0.5; height: 0.7"
                  material="src: #texturaPintura; transparent: true"
                  visible="false">
        </a-entity>
    </a-scene>

    <!-- Textura oculta -->
    <img id="texturaPintura" src="assets/mexico/mexico3.jpg" crossorigin="anonymous" style="display:none;">

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    (function() {
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const warningEl = document.getElementById('mobile-warning');
        const sizeSelectEl = document.getElementById('size-select');
        const loaderEl = document.getElementById('loader');
        const sceneEl = document.querySelector('a-scene');

        if (!isMobile) {
            // Mostrar overlay de advertencia
            warningEl.style.display = 'flex';
            // Ocultar elementos AR
            sizeSelectEl.style.display = 'none';
            loaderEl.style.display = 'none';
            sceneEl.style.display = 'none';

            // Volver a index.html
            document.getElementById('btn-back').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            return;
        }

        // Si es mobile, inicializamos selector de tamaños
        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const w = btn.dataset.width / 100;
                const h = btn.dataset.height / 100;
                document.getElementById('painting').setAttribute('geometry', { width: w, height: h });
            });
        });

        // Eventos Hit Test
        sceneEl.addEventListener('enter-vr', () => {
            if (!sceneEl.is('ar-mode')) return;
            loaderEl.style.display = 'flex';

            sceneEl.addEventListener('ar-hit-test-achieved', () => {
                loaderEl.style.display = 'none';
            }, { once: true });

            sceneEl.addEventListener('ar-hit-test-select', (evt) => {
                const { position, orientation } = evt.detail;
                const painting = document.getElementById('painting');
                painting.object3D.position.copy(position);
                painting.object3D.quaternion.copy(orientation);
                painting.setAttribute('visible', 'true');
            }, { once: true });
        });
    })();
    </script>
</body>
</html>
