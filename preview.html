<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pintura AR - Preview</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    body {
      background-color: #404040;
      color: white;
      font-family: Arial, sans-serif;
    }

    .main-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 0;
    }

    .preview-card {
      background-color: #606060;
      border-radius: 10px;
      max-width: 100%;
      width: 100%;
    }

    .card-header {
      background-color: #505050;
      border-radius: 10px 10px 0 0;
      text-align: center;
      padding: 20px;
    }

    .card-header h1 {
      font-size: 1.5rem;
      margin: 0;
    }

    .card-header p {
      margin: 10px 0 0 0;
      font-size: 0.9rem;
      color: #cccccc;
    }

    .painting-preview {
      width: 100%;
      max-width: 200px;
      height: auto;
      aspect-ratio: 1;
      border: 2px solid #808080;
      border-radius: 8px;
      object-fit: cover;
      background-color: #404040;
    }

    .painting-info {
      background-color: #505050;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }

    .painting-info h5 {
      margin: 0 0 5px 0;
      font-size: 1rem;
    }

    .painting-info p {
      margin: 0;
      font-size: 0.9rem;
      color: #cccccc;
    }

    .instructions {
      background-color: #505050;
      border-radius: 8px;
      padding: 15px;
    }

    .instructions h6 {
      margin: 0 0 15px 0;
      font-size: 1rem;
    }

    .instructions ul {
      margin: 0;
      padding-left: 20px;
    }

    .instructions li {
      margin: 8px 0;
      font-size: 0.9rem;
    }

    .error-alert {
      display: none;
    }

    .btn-ar {
      background-color: #808080;
      border-color: #808080;
      color: white;
      font-weight: bold;
      padding: 15px;
      font-size: 1.1rem;
    }

    .btn-ar:hover {
      background-color: #606060;
      border-color: #606060;
      color: white;
    }

    .btn-ar:disabled {
      background-color: #404040;
      border-color: #404040;
      color: #808080;
    }

    /* Warning para dispositivos no compatibles */
    .compatibility-warning {
      background-color: #8B0000;
      color: white;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }

    .compatibility-warning h5 {
      margin: 0 0 15px 0;
    }

    .compatibility-warning ul {
      text-align: left;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row justify-content-center main-container">
      <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5">
        
        <!-- Warning de compatibilidad (oculto por defecto) -->
        <div id="compatibility-warning" class="compatibility-warning" style="display: none;">
          <h5>Dispositivo No Compatible</h5>
          <p>Esta experiencia AR requiere:</p>
          <ul>
            <li>Dispositivo móvil (Android/iOS)</li>
            <li>Navegador compatible con cámara</li>
            <li>Conexión a internet</li>
          </ul>
          <button class="btn btn-secondary" onclick="location.reload()">Reintentar</button>
        </div>

        <!-- Card principal -->
        <div class="preview-card">
          <!-- Header -->
          <div class="card-header">
            <h1>Pintura AR</h1>
            <p>Visualiza tu obra en realidad aumentada</p>
          </div>

          <!-- Contenido del card -->
          <div class="card-body p-4">
            
            <!-- Preview de la imagen -->
            <div class="text-center mb-4">
              <img id="painting-preview" 
                   class="painting-preview" 
                   src="assets/animales/animales11.jpg" 
                   alt="Preview de la pintura"
                   onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNDA0MDQwIiBzdHJva2U9IiM4MDgwODAiIHN0cm9rZS13aWR0aD0iMiIvPgogIDx0ZXh0IHg9IjUwJSIgeT0iNDUlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM4MDgwODAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZW4gbm88L3RleHQ+CiAgPHRleHQgeD0iNTAlIiB5PSI1NSUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzgwODA4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPmVuY29udHJhZGE8L3RleHQ+Cjwvc3ZnPg=='">
              
              <div class="painting-info">
                <h5>Dimensiones</h5>
                <p><strong>50 × 50 cm</strong> (tamaño real en AR)</p>
              </div>
            </div>

            <!-- Instrucciones -->
            <div class="instructions mb-4">
              <h6>Instrucciones de uso:</h6>
              <ul>
                <li>Permite el acceso a la cámara cuando se solicite</li>
                <li>Busca una pared lisa y bien iluminada</li>
                <li>Mantén el dispositivo estable</li>
                <li>Toca la pantalla para colocar la pintura</li>
              </ul>
            </div>

            <!-- Mensajes de error -->
            <div id="error-alert" class="alert alert-danger error-alert" role="alert">
              <span id="error-message"></span>
            </div>

            <!-- Botón para iniciar AR -->
            <div class="d-grid">
              <button id="btn-start-ar" class="btn btn-ar">
                Iniciar Realidad Aumentada
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    class PreviewApp {
      constructor() {
        this.init();
      }

      init() {
        console.log('Inicializando Preview App...');
        this.setupElements();
        this.checkCompatibility();
        this.setupEventListeners();
      }

      setupElements() {
        this.startBtn = document.getElementById('btn-start-ar');
        this.errorAlert = document.getElementById('error-alert');
        this.errorMessage = document.getElementById('error-message');
        this.compatibilityWarning = document.getElementById('compatibility-warning');
      }

      checkCompatibility() {
        // Verificar dispositivo móvil
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Verificar soporte de cámara
        const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        
        // Verificar WebGL básico
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        const hasWebGL = !!gl;
        
        console.log('Compatibility check:', { isMobile, hasGetUserMedia, hasWebGL });
        
        if (!isMobile || !hasGetUserMedia || !hasWebGL) {
          this.showCompatibilityWarning();
          return false;
        }
        
        return true;
      }

      showCompatibilityWarning() {
        this.compatibilityWarning.style.display = 'block';
        this.startBtn.disabled = true;
      }

      setupEventListeners() {
        this.startBtn.addEventListener('click', () => this.startAR());
      }

      async startAR() {
        try {
          console.log('Verificando permisos de cámara...');
          this.startBtn.disabled = true;
          this.startBtn.textContent = 'Verificando cámara...';
          
          // Verificar acceso a la cámara
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280, max: 1920 },
              height: { ideal: 720, max: 1080 }
            } 
          });
          
          // Detener stream inmediatamente
          stream.getTracks().forEach(track => track.stop());
          
          console.log('Cámara verificada, redirigiendo a AR...');
          
          // Redirigir a la página AR
          window.location.href = 'ar.html';
          
        } catch (error) {
          console.error('Error al verificar cámara:', error);
          this.showError('No se pudo acceder a la cámara. Verifica los permisos del navegador.');
          this.startBtn.disabled = false;
          this.startBtn.textContent = 'Iniciar Realidad Aumentada';
        }
      }

      showError(message) {
        this.errorMessage.textContent = message;
        this.errorAlert.style.display = 'block';
        
        setTimeout(() => {
          this.errorAlert.style.display = 'none';
        }, 5000);
      }
    }

    // Inicializar cuando se cargue el DOM
    document.addEventListener('DOMContentLoaded', () => {
      new PreviewApp();
    });
  </script>
</body>
</html>